/**
 * API Layer for Knowledge Hub
 * Following the API → Hooks → UI pattern from coding principles
 */

// Types imported from types/knowledge-center.ts
import { Knowledge, MediaType, Webinar, Konten, KnowledgeAnalytics } from '@/types/knowledge-center';

export interface WebinarSchedule {
  id: string;
  title: string;
  description: string;
  tgl_zoom: string;
  zoom_link: string;
  youtube_link: string;
  speaker: string;
  max_participants: number;
  current_participants: number;
  is_active: boolean;
}

// KnowledgeAnalytics imported from types/knowledge-center.ts

export interface KnowledgeQueryParams {
  search?: string;
  knowledge_type?: ('webinar' | 'konten')[];
  subject?: string[];
  sort?: 'newest' | 'oldest' | 'most_liked' | 'most_viewed' | 'upcoming_webinar' | 'popular' | 'likes' | 'title';
  page?: number;
  limit?: number;
}

export interface KnowledgeResponse {
  data: Knowledge[];
  total: number;
  page: number;
  limit: number;
  total_pages: number;
}

// Dummy Data Generator
const generateDummyKnowledge = (): Knowledge[] => {
  const subjects = ['Data Science', 'Machine Learning', 'Web Development', 'Mobile Development', 'DevOps', 'Cloud Computing', 'Cybersecurity', 'UI/UX Design'];
  const penyelenggaras = ['Pusdiklat BPS', 'BPS Sumatera Barat', 'BPS DKI Jakarta', 'BPS Jawa Tengah', 'BPS DI Yogyakarta'];
  const mediaTypes: MediaType[] = ['video', 'pdf', 'audio', 'article'];

  return Array.from({ length: 50 }, (_, index) => {
    const id = `knowledge-${index + 1}`;
    const subject = subjects[index % subjects.length];
    const isWebinar = index % 3 === 0;
    const penyelenggara = penyelenggaras[index % penyelenggaras.length];

    const baseFields = {
      id,
      title: `${isWebinar ? 'Webinar' : 'Content'} ${index + 1}: ${subject} Fundamentals`,
      description: `Comprehensive ${isWebinar ? 'webinar' : 'content'} covering the fundamentals of ${subject}. Perfect for beginners and intermediate learners looking to enhance their skills.`,
      subject,
      knowledge_type: isWebinar ? 'webinar' as const : 'konten' as const,
      penyelenggara,
      thumbnail: `https://picsum.photos/400/225?random=${index}`,
      author: `Expert ${index + 1}`,
      like_count: Math.floor(Math.random() * 1000),
      dislike_count: Math.floor(Math.random() * 100),
      view_count: Math.floor(Math.random() * 10000),
      tags: [subject.toLowerCase(), isWebinar ? 'webinar' : 'content'],
      created_at: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
      updated_at: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
      published_at: new Date(Date.now() - Math.random() * 20 * 24 * 60 * 60 * 1000).toISOString(),
    };

    if (isWebinar) {
      // Return Webinar type
      return {
        ...baseFields,
        tgl_zoom: new Date(Date.now() + Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
        link_zoom: `https://zoom.us/webinar/${index}`,
        link_youtube: `https://youtube.com/watch?v=${index}`,
        link_vb: `https://virtual-background.com/${index}`,
        file_notulensi_pdf: `https://example.com/notulensi/${id}.pdf`,
        content_richtext: `<p>Webinar content for ${subject} fundamentals...</p>`,
        jumlah_jp: Math.floor(Math.random() * 8) + 2,
        gojags_ref: `GOJAGS-${index}`,
      } as Webinar;
    } else {
      // Return Konten type
      const mediaType = mediaTypes[index % mediaTypes.length];
      return {
        ...baseFields,
        media_resource: `https://example.com/media/${id}.${mediaType === 'video' ? 'mp4' : mediaType === 'pdf' ? 'pdf' : mediaType === 'audio' ? 'mp3' : 'html'}`,
        media_type: mediaType,
        content_richtext: `<p>Content about ${subject} fundamentals...</p>`,
      } as Konten;
    }
  });
};

const generateDummyWebinarSchedule = (): WebinarSchedule[] => {
  const now = new Date();
  return Array.from({ length: 10 }, (_, index) => {
    const date = new Date(now.getTime() + (index * 24 * 60 * 60 * 1000)); // Next 10 days
    return {
      id: `webinar-schedule-${index + 1}`,
      title: `Advanced Webinar ${index + 1}`,
      description: `Advanced topics and best practices in modern technology and development.`,
      tgl_zoom: date.toISOString(),
      zoom_link: `https://zoom.us/webinar/${index + 1}`,
      youtube_link: `https://youtube.com/watch?v=${index + 1}`,
      speaker: `Industry Expert ${index + 1}`,
      max_participants: 100,
      current_participants: Math.floor(Math.random() * 100),
      is_active: true,
    };
  });
};

// In-memory storage for dummy data
const dummyKnowledgeStore = generateDummyKnowledge();

const generateDummyAnalytics = (): KnowledgeAnalytics => {
  return {
    total_knowledge: 156,
    total_webinars: 45,
    total_published: 134,
    total_likes: 3421,
    total_dislikes: 234,
    total_views: 25678,
    upcoming_webinars: 8,
    top_subjects: [
      { subject: 'Data Science', count: 34 },
      { subject: 'Web Development', count: 28 },
      { subject: 'Machine Learning', count: 22 },
      { subject: 'Mobile Development', count: 18 },
      { subject: 'UI/UX Design', count: 15 },
    ],
    popular_knowledge: dummyKnowledgeStore.slice(0, 5),
  };
};
const dummyWebinarScheduleStore = generateDummyWebinarSchedule();
const dummyAnalyticsStore = generateDummyAnalytics();

// API Functions
export const knowledgeApi = {
  /**
   * Fetch knowledge items with filtering and pagination
   */
  async fetchKnowledge(params: KnowledgeQueryParams = {}): Promise<KnowledgeResponse> {
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 800));

    let filteredData = [...dummyKnowledgeStore];

    // Apply search filter
    if (params.search) {
      const searchLower = params.search.toLowerCase();
      filteredData = filteredData.filter(item =>
        item.title.toLowerCase().includes(searchLower) ||
        item.description.toLowerCase().includes(searchLower) ||
        item.subject.toLowerCase().includes(searchLower) ||
        item.tags.some(tag => tag.toLowerCase().includes(searchLower))
      );
    }

    // Apply knowledge type filter
    if (params.knowledge_type && params.knowledge_type.length > 0) {
      filteredData = filteredData.filter(item =>
        params.knowledge_type!.includes(item.knowledge_type)
      );
    }

    // Apply subject filter
    if (params.subject && params.subject.length > 0) {
      filteredData = filteredData.filter(item =>
        params.subject!.includes(item.subject)
      );
    }

    // Apply sorting
    if (params.sort) {
      switch (params.sort) {
        case 'newest':
          filteredData.sort((a, b) => new Date(b.created_at || '').getTime() - new Date(a.created_at || '').getTime());
          break;
        case 'most_liked':
          filteredData.sort((a, b) => b.like_count - a.like_count);
          break;
        case 'most_viewed':
          filteredData.sort((a, b) => b.view_count - a.view_count);
          break;
        case 'upcoming_webinar':
          filteredData = filteredData.filter(item => item.knowledge_type === 'webinar');
          filteredData.sort((a, b) => new Date(a.created_at || '').getTime() - new Date(b.created_at || '').getTime());
          break;
        case 'popular':
          filteredData.sort((a, b) => (b.like_count + b.view_count) - (a.like_count + a.view_count));
          break;
        case 'oldest':
          filteredData.sort((a, b) => new Date(a.created_at || '').getTime() - new Date(b.created_at || '').getTime());
          break;
        case 'title':
          filteredData.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'likes':
          filteredData.sort((a, b) => b.like_count - a.like_count);
          break;
      }
    }

    const total = filteredData.length;
    const page = params.page || 1;
    const limit = params.limit || 12;
    const startIndex = (page - 1) * limit;
    const endIndex = startIndex + limit;
    const paginatedData = filteredData.slice(startIndex, endIndex);
    const totalPages = Math.ceil(total / limit);

    return {
      data: paginatedData,
      total,
      page,
      limit,
      total_pages: totalPages,
    };
  },

  /**
   * Fetch single knowledge item by ID
   */
  async fetchKnowledgeById(id: string): Promise<Knowledge | null> {
    await new Promise(resolve => setTimeout(resolve, 300));
    return dummyKnowledgeStore.find(item => item.id === id) || null;
  },

  /**
   * Fetch webinar schedule
   */
  async fetchWebinarSchedule(): Promise<WebinarSchedule[]> {
    await new Promise(resolve => setTimeout(resolve, 500));
    return [...dummyWebinarScheduleStore];
  },

  /**
   * Fetch knowledge analytics
   */
  async fetchKnowledgeAnalytics(): Promise<KnowledgeAnalytics> {
    await new Promise(resolve => setTimeout(resolve, 400));
    return { ...dummyAnalyticsStore };
  },

  /**
   * Create new knowledge (for future use)
   */
  async createKnowledge(data: Partial<Knowledge>): Promise<Knowledge> {
    await new Promise(resolve => setTimeout(resolve, 1000));

    const isWebinar = data.knowledge_type === 'webinar';
    const baseFields = {
      id: `knowledge-${Date.now()}`,
      title: data.title || 'New Knowledge',
      description: data.description || '',
      knowledge_type: data.knowledge_type || 'konten',
      subject: data.subject || 'General',
      penyelenggara: data.penyelenggara || 'Pusdiklat BPS',
      thumbnail: data.thumbnail || 'https://picsum.photos/400/225?random=' + Date.now(),
      author: data.author || 'Anonymous',
      like_count: 0,
      dislike_count: 0,
      view_count: 0,
      tags: data.tags || [],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      published_at: new Date().toISOString(),
    };

    let newKnowledge: Knowledge;

    if (isWebinar) {
      newKnowledge = {
        ...baseFields,
        tgl_zoom: (data as any).tgl_zoom,
        link_zoom: (data as any).link_zoom || `https://zoom.us/webinar/${Date.now()}`,
        link_youtube: (data as any).link_youtube,
        link_record: (data as any).link_record,
        link_vb: (data as any).link_vb,
        file_notulensi_pdf: (data as any).file_notulensi_pdf,
        content_richtext: (data as any).content_richtext || '<p>New webinar content...</p>',
        jumlah_jp: (data as any).jumlah_jp || 2,
        gojags_ref: (data as any).gojags_ref || `GOJAGS-${Date.now()}`,
      } as Webinar;
    } else {
      newKnowledge = {
        ...baseFields,
        media_resource: (data as any).media_resource,
        media_type: (data as any).media_type || 'video',
        content_richtext: (data as any).content_richtext || '<p>New content...</p>',
      } as Konten;
    }

    dummyKnowledgeStore.push(newKnowledge);
    return newKnowledge;
  },

  /**
   * Update knowledge (for future use)
   */
  async updateKnowledge(id: string, data: Partial<Knowledge>): Promise<Knowledge | null> {
    await new Promise(resolve => setTimeout(resolve, 800));
    const index = dummyKnowledgeStore.findIndex(item => item.id === id);
    if (index === -1) return null;

    dummyKnowledgeStore[index] = {
      ...dummyKnowledgeStore[index],
      ...data,
      updated_at: new Date().toISOString(),
    };

    return dummyKnowledgeStore[index];
  },

  /**
   * Delete knowledge (for future use)
   */
  async deleteKnowledge(id: string): Promise<boolean> {
    await new Promise(resolve => setTimeout(resolve, 500));
    const index = dummyKnowledgeStore.findIndex(item => item.id === id);
    if (index === -1) return false;

    dummyKnowledgeStore.splice(index, 1);
    return true;
  },

  /**
   * Like/unlike knowledge (for future use)
   */
  async toggleLikeKnowledge(id: string): Promise<{ liked: boolean; totalLikes: number }> {
    await new Promise(resolve => setTimeout(resolve, 300));
    const knowledge = dummyKnowledgeStore.find(item => item.id === id);
    if (!knowledge) throw new Error('Knowledge not found');

    // Simulate toggle like (in real app, this would track user's like)
    const liked = Math.random() > 0.5;
    if (liked) {
      knowledge.likes++;
    } else {
      knowledge.likes = Math.max(0, knowledge.likes - 1);
    }

    return {
      liked,
      totalLikes: knowledge.likes,
    };
  },

  /**
   * Increment view count (for future use)
   */
  async incrementViews(id: string): Promise<{ totalViews: number }> {
    await new Promise(resolve => setTimeout(resolve, 200));
    const knowledge = dummyKnowledgeStore.find(item => item.id === id);
    if (!knowledge) throw new Error('Knowledge not found');

    knowledge.views++;
    return {
      totalViews: knowledge.views,
    };
  },
};

// Query Options for React Query
export const getKnowledgeQueryOptions = (params: KnowledgeQueryParams = {}) => ({
  queryKey: ['knowledge', params],
  queryFn: () => knowledgeApi.fetchKnowledge(params),
  staleTime: 1000 * 60 * 5, // 5 minutes
  gcTime: 1000 * 60 * 10, // 10 minutes
});

export const getKnowledgeByIdQueryOptions = (id: string) => ({
  queryKey: ['knowledge', id],
  queryFn: () => knowledgeApi.fetchKnowledgeById(id),
  staleTime: 1000 * 60 * 10, // 10 minutes
  gcTime: 1000 * 60 * 15, // 15 minutes
});

export const getWebinarScheduleQueryOptions = () => ({
  queryKey: ['webinar-schedule'],
  queryFn: () => knowledgeApi.fetchWebinarSchedule(),
  staleTime: 1000 * 60 * 2, // 2 minutes
  gcTime: 1000 * 60 * 5, // 5 minutes
  refetchInterval: 1000 * 60 * 5, // Refetch every 5 minutes
});

export const getKnowledgeAnalyticsQueryOptions = () => ({
  queryKey: ['knowledge-analytics'],
  queryFn: () => knowledgeApi.fetchKnowledgeAnalytics(),
  staleTime: 1000 * 60 * 10, // 10 minutes
  gcTime: 1000 * 60 * 15, // 15 minutes
  refetchInterval: 1000 * 60 * 10, // Refetch every 10 minutes
});